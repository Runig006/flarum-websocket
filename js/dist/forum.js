module.exports=function(e){var t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=29)}([function(e,t){e.exports=flarum.core.compat.app},function(e,t){e.exports=flarum.core.compat["utils/Stream"]},function(e,t){e.exports=flarum.core.compat.extend},function(e,t,s){"use strict";function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,n(e,t)}s.d(t,"a",(function(){return r}))},function(e,t){e.exports=flarum.core.compat["utils/stringToColor"]},function(e,t){e.exports=flarum.core.compat["helpers/avatar"]},function(e,t){e.exports=flarum.core.compat["components/DiscussionPage"]},function(e,t){e.exports=flarum.core.compat["extensions/afrux-forum-widgets-core/common/components/Widget"]},,function(e,t){e.exports=flarum.core.compat["extensions/afrux-forum-widgets-core/common/extend/Widgets"]},function(e,t){e.exports=flarum.core.compat["components/LoadingIndicator"]},function(e,t){e.exports=flarum.core.compat["components/Tooltip"]},function(e,t){e.exports=flarum.core.compat["components/Link"]},function(e,t,s){"use strict";var n=s(9),r=s.n(n),o=s(3),i=s(10),a=s.n(i),u=s(11),c=s.n(u),p=s(5),d=s.n(p),l=s(12),f=s.n(l),b=s(4),h=s.n(b),y=s(1),g=s.n(y),w=s(7),v=s.n(w),x=v.a?function(e){function t(){return e.apply(this,arguments)||this}Object(o.a)(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.users=[],this.loading=!0,this.guests=0},s.oncreate=function(t){var s=this;e.prototype.oncreate.call(this,t),app.pusher.then((function(e){var t=e.channels.presence,n=Object.keys(t.members.members),r=!app.session.user||app.session.user&&!app.session.user.preferences().discloseOnline;0===n.length?(t.bind("pusher:subscription_succeeded",(function(e){Object.keys(e.members).map((function(t){t.includes("Guest")?s.guests++:(e.members[t].id=t,s.pushMember(e.members[t]))})),s.loading=!1,m.redraw()})),r&&(s.guests--,m.redraw())):(n.map((function(e){e.includes("Guest")?s.guests++:(t.members.members[e].id=e,s.pushMember(t.members.members[e]))})),s.loading=!1,r&&(s.guests--,m.redraw())),t.bind("pusher:member_removed",(function(e){"string"!=typeof e.id?s.users.some((function(t,n){if(t.id()==e.id)return s.users.splice(n,1),!0})):s.guests--,m.redraw()})),t.bind("pusher:member_added",(function(e){"string"!=typeof e.id?(e.info.id=e.id,s.pushMember(e.info)):s.guests++,m.redraw()}))}))},s.pushMember=function(e){this.users.push({id:g()(e.id),color:g()("#"+h()(e.displayName)),displayName:g()(e.displayName),avatarUrl:g()(e.avatarUrl),slug:g()(e.slug)})},s.className=function(){return"WebsocketOnlineUsersWidget"},s.icon=function(){return"fas fa-user-friends"},s.title=function(){return app.translator.trans("kyrne-websocket.forum.widget.title")},s.content=function(){if(this.loading)return m(a.a,null);var e=this.users;return m("div",{className:"WebsocketOnlineUsersWidget-users"},m("div",{className:"WebsocketOnlineUsersWidget-users-message"},0===e.length?app.translator.trans("kyrne-websocket.forum.widget.empty"):null),m("div",{className:"WebsocketOnlineUsersWidget-users-list"},e.slice(0,12).map((function(e){return m(f.a,{href:app.route("user",{username:e.slug()}),className:"WebsocketOnlineUsersWidget-users-item"},m(c.a,{text:e.displayName()},d()(e)))})),this.guests>0?m("span",{style:e.length>0?"margin-left: 8px":"",className:"WebsocketOnlineUsersWidget-users-guests"},app.translator.trans("kyrne-websocket.forum.widget.guests",{count:this.guests})):"",e.length>12?m("span",{className:"WebsocketOnlineUsersWidget-users-item WebsocketOnlineUsersWidget-users-item--plus"},m("span",{className:"Avatar"},"+12")):null))},t}(v.a):function(){};t.a=function(e){(new r.a).add({key:"WebsocketOnlineUsersWidget",component:x,isDisabled:!1,placement:"end",position:1}).extend(e,"kyrne-websocket")}},function(e,t){e.exports=flarum.core.compat["common/components/SettingsPage"]},function(e,t){e.exports=flarum.core.compat["components/ReplyComposer"]},function(e,t){e.exports=flarum.core.compat["components/ReplyPlaceholder"]},function(e,t){e.exports=flarum.core.compat["helpers/username"]},function(e,t){e.exports=flarum.core.compat["components/DiscussionList"]},function(e,t){e.exports=flarum.core.compat["components/IndexPage"]},function(e,t){e.exports=flarum.core.compat["common/extend"]},function(e,t){e.exports=flarum.core.compat["common/components/FieldSet"]},function(e,t){e.exports=flarum.core.compat["common/components/Switch"]},function(e,t){e.exports=flarum.core.compat["common/utils/ItemList"]},,,,,,function(e,t,s){"use strict";s.r(t);var n=s(2),r=s(0),o=s.n(r),i=s(18),a=s.n(i),u=s(6),c=s.n(u),p=s(19),d=s.n(p),l=s(20),f=s(21),b=s.n(f),h=s(14),y=s.n(h),g=s(22),w=s.n(g),v=s(23),x=s.n(v),O=s(15),k=s.n(O),N=s(16),j=s.n(N),P=s(5),U=s.n(P),T=s(17),_=s.n(T),W=s(1),S=s.n(W),C=s(4),I=s.n(C),M=s(13);o.a.initializers.add("kyrne-websocket",(function(){Object(l.extend)(y.a.prototype,"settingsItems",(function(e){e.add("disabler-auto-fresh",b.a.component({label:app.translator.trans("kyrne-websocket.forum.settings.heading"),className:"disable-auto-fresh"},this.disabledAutoFresh().toArray()))})),y.a.prototype.disabledAutoFresh=function(){var e=this,t=new x.a;return t.add("disable-auto-fresh",w.a.component({state:this.user.preferences().disableAutoFresh,onchange:function(t){e.disableAutoFresh=t,e.user.savePreferences({disableAutoFresh:t}).then((function(){m.redraw()}))}},app.translator.trans("kyrne-websocket.forum.settings.label"))),t};var e=new Promise((function(e,t){"connected"!==o.a.socketStatus&&$.getScript("https://cdn.jsdelivr.net/npm/pusher-js@7.0.3/dist/web/pusher.min.js",(function(){if(!o.a.session.user&&o.a.forum.attribute("websocketAuthOnly"))return!1;o.a.forum.attribute("debug")&&(Pusher.logToConsole=!0);var t="1"===o.a.forum.attribute("websocketReverseProxy")?443:o.a.forum.attribute("websocketPort")||2083,s=new Pusher(o.a.forum.attribute("websocketKey"),{authEndpoint:o.a.forum.attribute("apiUrl")+"/websocket/auth",cluster:null,wsHost:o.a.forum.attribute("websocketHost")||window.location.hostname,wsPort:o.a.forum.attribute("websocketPort")||2083,wssPort:t,enableStats:!1,encrypted:o.a.forum.attribute("websocketSecure"),auth:{headers:{"X-CSRF-Token":o.a.session.csrfToken}},enabledTransports:["ws","flash"],disabledTransports:["xhr_polling","xhr_streaming","sockjs"]});return s.connection.bind("state_change",(function(e){return o.a.socketStatus=e.current})),e({channels:{main:s.subscribe("public"),user:o.a.session.user?s.subscribe("private-user"+o.a.session.user.id()):null,presence:s.subscribe("presence-forum")},pusher:s})}))}));o.a.pusher=e,o.a.pushedUpdates=[],Object(n.extend)(a.a.prototype,"oncreate",(function(e){o.a.pusher.then((function(e){var t=e.channels;Object.keys(t).map((function(e){null!==t[e]&&t[e].bind("newPost",(function(e){var t=String(e.discussionId),s=o.a.discussions.getParams();-1===["user.posts","user.discussions"].indexOf(o.a.current.data.routeName)&&1!=o.a.session.user.preferences().disableAutoFresh&&(s.q||o.a.current.get("discussion")&&t===o.a.current.get("discussion").id()||-1!==o.a.pushedUpdates.indexOf(t)||o.a.request({method:"GET",url:o.a.forum.attribute("apiUrl")+"/discussions/"+t}).then((function(e){if("ignore"!==e.data.attributes.subscription){if(s.filter&&s.filter.tag){var t=e.data.relationships.tags.data.map((function(e){return e.id})),n=[];if(s.filter.tag.split(",").forEach((function(e){var t=o.a.store.getBy("tags","slug",e);t&&n.push(t.data.id)})),0==t.some((function(e){return n.includes(e)})))return}if(o.a.forum.attribute("websocketAutoUpdate"))for(var r=o.a.discussions.getPages().length;r>0;r--)o.a.discussions.refresh(r);else o.a.pushedUpdates.push(e),o.a.current.matches(d.a)&&o.a.setTitleCount(o.a.pushedUpdates.length),m.redraw()}})))}))}))}))})),Object(n.extend)(c.a.prototype,"oncreate",(function(){var e=this;o.a.pusher.then((function(t){var s=t.channels;Object.keys(s).map((function(t){null!==s[t]&&s[t].bind("newPost",(function(t){var s=String(t.discussionId);if(e.discussion&&e.discussion.id()===s&&e.stream){var n=e.discussion.commentCount();o.a.store.find("discussions",e.discussion.id()).then((function(){e.stream.update().then((function(){document.hasFocus()||(o.a.setTitleCount(Math.max(0,e.discussion.commentCount()-n)),$(window).one("focus",(function(){return o.a.setTitleCount(0)}))),m.redraw()}))}))}}))}))}))})),Object(n.extend)(c.a.prototype,"onremove",(function(){o.a.pusher.then((function(e){var t=e.channels;Object.keys(t).map((function(e){null!==t[e]&&t[e].unbind("newPost")}))}))})),o.a.pusher.then((function(e){var t=e.channels;t.user&&t.user.bind("notification",(function(){o.a.session.user.pushAttributes({unreadNotificationCount:o.a.session.user.unreadNotificationCount()+1,newNotificationCount:o.a.session.user.newNotificationCount()+1}),m.redraw(),console.log(o.a.session.user.unreadNotificationCount());var e=document.querySelector(".MobileTab .item-notifications .unread");e&&(e.innerHTML=o.a.session.user.unreadNotificationCount())}))})),Object(n.extend)(c.a.prototype,"view",(function(e){var t=this;app.pusher.then((function(e){!app.discussions.presence&&t.discussion&&(app.discussions.presence=e.pusher.subscribe("presence-"+t.discussion.id()),app.discussions.presence.bind("pusher:subscription_succeeded",(function(e){t.membersOnline=[],Object.keys(e.members).map((function(s){app.discussions.presence.members.myID!=s&&"string"!=typeof s&&(t.membersOnline.push({id:S()(s),color:S()("#"+I()(e.members[s].displayName)),displayName:S()(e.members[s].displayName),avatarUrl:S()(e.members[s].avatarUrl)}),m.redraw())}))})),app.discussions.presence.bind("pusher:member_removed",(function(e){t.membersOnline.some((function(s,n){if(s.id()==e.id)return t.membersOnline.splice(n,1),m.redraw(),!0}))})),app.discussions.presence.bind("pusher:member_added",(function(e){app.discussions.presence.members.myID!=e.id&&"string"!=typeof e.id&&(t.membersOnline.push({id:S()(e.id),color:S()("#"+I()(e.info.displayName)),displayName:S()(e.info.displayName),avatarUrl:S()(e.info.avatarUrl)}),m.redraw())})))}))})),Object(n.extend)(c.a.prototype,"sidebarItems",(function(e){this.membersOnline&&this.membersOnline.length&&e.add("viewing",m("div",{className:"UsersOnline"},m("legend",{className:"UsersOnline-title"},app.translator.trans("kyrne-websocket.forum.discussion_page.viewing_title")),m("ul",{className:"UsersOnline-list"},this.membersOnline.map((function(e){return m("li",{className:"UsersOnline-item"},U()(e),_()(e))})))),-101)})),Object(n.extend)(c.a.prototype,"oncreate",(function(e){window.matchMedia("only screen and (max-width: 767px)").matches||$(window).on("scroll",(function(e){var t=$(".DiscussionPage-nav").children();$(window).scrollTop()>147?(t.css("position","fixed"),t.addClass("websocket-nav")):(t.css("position","absolute"),t.removeClass("websocket-nav"))}))})),Object(n.extend)(c.a.prototype,"onremove",(function(e){var t=this;app.pusher.then((function(e){app.discussions.presence&&(app.discussions.presence=e.pusher.unsubscribe("presence-"+t.discussion.id()),app.discussions.presence=null)}))})),Object(n.extend)(k.a.prototype,"oninit",(function(){var e=this;!function t(){e.typingTimeout=!0,setTimeout((function(){t()}),18e3)}()})),Object(n.extend)(k.a.prototype,"view",(function(){var e=this;app.session.user&&app.session.user.preferences().discloseOnline&&$(".TextEditor-editor").on("keydown",(function(){e.typingTimeout&&(e.typingTimeout=!1,app.request({method:"POST",url:app.forum.attribute("apiUrl")+"/posts/typing",body:{discussionId:e.attrs.discussion.id()}}))}))})),Object(n.extend)(j.a.prototype,"oninit",(function(){var e=this;this.typers={},setTimeout((function(){app.discussions.presence&&app.discussions.presence.bind("typing",(function(t){e.typers[t.userId]||t.userId==app.discussions.presence.members.myID||(e.typers[t.userId]={id:S()(t.userId),color:S()("#"+I()(t.displayName)),displayName:S()(t.displayName),avatarUrl:S()(t.avatarUrl),time:new Date}),m.redraw()}))}),2e3),function t(){Object.keys(e.typers).map((function(t){e.typers[t].time<new Date(Date.now()-2e4)&&(delete e.typers[t],m.redraw())})),setTimeout((function(){t()}),2e4)}()})),Object(n.extend)(j.a.prototype,"view",(function(e){var t=this;Object.keys(this.typers).length&&e.children.push(m("div",{className:"ReplyPlaceholder-typers"},m("ul",{className:"ReplyPlaceholder-typers-list"},Object.keys(this.typers).map((function(e){return m("li",{className:"ReplyPlaceholder-typers-item"},U()(t.typers[e]),_()(t.typers[e]),m("div",{className:"tiblock"},m("div",{className:"tidot"}),m("div",{className:"tidot"}),m("div",{className:"tidot"})))})))))})),o.a.initializers.has("afrux/forum-widgets-core")&&Object(M.a)(o.a)}))}]);
//# sourceMappingURL=forum.js.map